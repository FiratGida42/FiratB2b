<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - B2B Portalı</title>

    <!-- PWA Manifest Linki -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#4a90e2">
    
    <!-- Bootswatch Yeti Theme CSS -->
    <link href="https://bootswatch.com/5/yeti/bootstrap.min.css" rel="stylesheet">
    <!-- Lightgallery CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" />

    <style>
        body {
            padding-top: 56px; 
            background-color: #f8f9fa; /* Bu arkaplan rengi temaya göre ayarlanabilir veya kaldırılabilir */
        }
        h1.page-title {
            margin-bottom: 20px; 
        }
        /* Navbar'ın Yeti temasında daha belirgin olması için (isteğe bağlı) */
        .navbar.bg-dark {
            /* Yeti'nin kendi koyu rengi zaten güzel, ama isterseniz buradan değiştirebilirsiniz */
            /* Örneğin: background-color: #343a40 !important; */
        }
        /* Stok Adı sütunu için özel stil */
        .col-stok-adi {
            min-width: 180px; /* Mobil cihazlarda Stok Adı sütununun minimum genişliği */
            /* white-space: nowrap; */ /* İçeriğin taşmasını ve alt satıra kaymamasını istiyorsanız bunu aktif edebilirsiniz */
        }
        #product-search-input {
            margin-bottom: 20px;
        }
        /* Tablodaki resimler için stil */
        .product-image {
            max-height: 50px; 
            max-width: 70px;  
            height: auto;     /* Değişiklik: Sabit yükseklik yerine auto */
            width: auto;      /* Değişiklik: Sabit genişlik yerine auto */
            object-fit: contain; /* Değişiklik: cover -> contain */
            display: block; 
            margin: auto;   
            cursor: pointer; 
        }
        /* Lightgallery'nin z-index'ini Bootstrap modal'larından yüksek yapmak için (gerekirse) */
        .lg-outer {
            z-index: 1060; /* Bootstrap modal z-index'i 1050-1055 civarıdır */
        }
        /* Kenar çubuğu stilleri kaldırıldı */

        /* Aktif linkler için daha belirgin stil */
        .navbar-nav .nav-link.active-main-category,
        .navbar-nav .dropdown-item.active-sub-category { /* .active-sub-category dropdown item'lara uygulanacak */
            font-weight: bold;
            color: #0d6efd !important; /* Bootstrap primary rengi, important gerekebilir */
            background-color: rgba(13, 110, 253, 0.1) !important; /* Hafif bir arka plan */
        }
        .navbar-nav .dropdown-toggle.active-main-category { /* Sadece dropdown toggle olan ana kategori için */
             color: #fff !important; /* Yeti temasında beyaz kalması için */
             /* background-color: rgba(255,255,255,0.1); /* İsteğe bağlı hafif vurgu */
        }
        /* Sepet ve ürün tablosu için ek stiller */
        .action-cell {
            /* min-width: 120px; */ /* Önceki min-width değeri */
            width: 16px !important;       /* Yeni dar genişlik, sadece ikon için */
            min-width: 16px !important;   /* Yeni dar min-width, sadece ikon için */
            padding: 0 !important;        /* Hücre iç boşluğunu sıfırla */
            text-align: center;
            vertical-align: middle;
        }
        .cart-icon-button {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important; /* Dış boşlukları da sıfırla */
            background-color: transparent !important;
            width: 16px;
            height: 16px;
            display: inline-flex; /* veya flex */
            align-items: center;
            justify-content: center;
            color: #0d6efd; /* Bootstrap primary rengi, outline-primary'den gelen */
        }
        .cart-icon-button:hover {
            color: #0a58ca; /* Bootstrap primary hover rengi */
        }
        /* Lightgallery mobil kapatma butonu için CSS */
        .lg-toolbar .lg-close.lg-icon {
            display: inline-block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        #cartSection th, #cartSection td {
            vertical-align: middle;
        }
        .quantity-input {
            width: 70px;
            text-align: center;
        }
        @media (max-width: 767px) { /* Sadece mobil cihazlar (Bootstrap sm breakpoint'i baz alındı) */
            .lg-outer .lg-toolbar { /* Lightgallery dış sarmalayıcısı içindeki toolbar */
                display: flex !important;
                opacity: 1 !important;
                visibility: visible !important;
                background-color: rgba(0,0,0,0.3) !important; /* Toolbar'ı daha görünür yapmak için (isteğe bağlı) */
                padding: 5px !important; /* Toolbar için iç boşluk */
                height: auto !important; /* Toolbar yüksekliğini otomatik ayarla */
            }
            .lg-outer .lg-toolbar .lg-close.lg-icon {
                display: inline-block !important;
                opacity: 1 !important;
                visibility: visible !important;
                color: #FFF !important; /* İkon rengini beyaz yapalım */
                font-size: 28px !important; /* İkon boyutunu biraz büyütelim */
                width: 35px !important;    /* Dokunma alanını genişletelim */
                height: 35px !important;   /* Dokunma alanını genişletelim */
                line-height: 35px !important; /* İkonu dikeyde ortala */
                text-align: center !important; /* İkonu yatayda ortala */
                position: absolute !important; /* Konumlandırmayı kesinleştirelim */
                top: 5px !important;          /* Üstten boşluk */
                right: 5px !important;         /* Sağdan boşluk */
                z-index: 999999 !important;    /* Diğer tüm elementlerin üzerinde olmasını garantile */
                background-color: rgba(0,0,0,0.2) !important; /* Buton arka planı (isteğe bağlı) */
                border-radius: 50% !important; /* Butonu yuvarlak yapalım (isteğe bağlı) */
            }
             /* Eğer yukarıdaki işe yaramazsa, Lightgallery'nin kendi mobil stillerini ezmeye çalışalım */
            .lg-mobile-only .lg-close {
                display: block !important;
                opacity: 1 !important;
            }

            /* Mobil cihazlarda navbar dropdown menüleri için kaydırma */
            .navbar-nav .dropdown-menu.show { /* .show sınıfını ekledik */
                max-height: 45vh; 
                overflow-y: auto !important; 
                -webkit-overflow-scrolling: touch; 
            }
        }
    </style>

    <script>
        // Service Worker'ı kaydet
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('Service Worker başarıyla kaydedildi: ', registration);
                        
                        // Eğer yeni bir Service Worker kuruluyorsa otomatik aktif et
                        if (registration.waiting) {
                            registration.waiting.postMessage({type: 'SKIP_WAITING'});
                        }
                        
                        registration.addEventListener('updatefound', () => {
                            console.log('Yeni Service Worker versiyonu bulundu.');
                        });
                    })
                    .catch(registrationError => {
                        console.error('Service Worker kaydı başarısız: ', registrationError);
                    });
            });
        } else {
            console.warn('Bu tarayıcı Service Worker desteklemiyor.');
        }

        // --- IndexedDB Helper Fonksiyonları Başlangıç ---
        function openDB(name, version = 2) {
            return new Promise((resolve, reject) => {
                try {
                    const request = indexedDB.open(name, version);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('keyval')) {
                            db.createObjectStore('keyval');
                        }
                        if (!db.objectStoreNames.contains('sync-orders')) {
                            db.createObjectStore('sync-orders', { autoIncrement: true });
                        }
                    };
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function getFromDB(db, key) {
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction('keyval', 'readonly');
                    const store = tx.objectStore('keyval');
                    const request = store.get(key);
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function setInDB(db, key, value) {
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction('keyval', 'readwrite');
                    const store = tx.objectStore('keyval');
                    const putRequest = store.put(value, key);
                    putRequest.onsuccess = () => resolve();
                    putRequest.onerror = (event) => reject(event.target.error);
                    tx.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        // --- IndexedDB Helper Fonksiyonları Bitiş ---

        const AnaKategoriYapisi = [
            {
                ad: "GIDA ÜRÜNLERİ",
                id: "gida",
                grupKodlari: ["BAKLIYAT", "MAKARNA", "UN", "CORBA", "BASAK", "KAHVALTI", "COKOKREM", "ETI", "GOFRET", "JELIBON", "LOKUM", "HELVA", "BAYRAM", "KENT", "KONSERVE", "BALIK", "KENTON", "DRO"]
            },
            {
                ad: "İÇECEKLER",
                id: "icecekler",
                grupKodlari: ["CAY", "KAHVE", "ICECEK"]
            },
            {
                ad: "TEMİZLİK & K. BAKIM",
                id: "temizlik",
                grupKodlari: ["DETERJAN", "KOZMETIK", "PED", "BEZ", "MENDIL", "ISLAK"]
            },
            {
                ad: "EV YAŞAM & GEREÇLERİ",
                id: "evyasam",
                grupKodlari: ["BARDAK", "KAGIT"]
            },
            {
                ad: "DİĞER ÜRÜNLER", 
                id: "diger",
                grupKodlari: ["01", "DIGER"]
            }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            const productTableContainer = document.getElementById('products-table-container');
            const searchInput = document.getElementById('product-search-input');
            const mainCategoriesNav = document.getElementById('main-categories-nav');
            const quickStockCodeInput = document.getElementById('quick-stock-code-input');
            const quickAddByStockCodeButton = document.getElementById('quick-add-by-stock-code-button');
            const syncButton = document.getElementById('sync-button'); // Butonu değişkene ata
            
            let allProducts = []; 
            let activeCategoryStructure = []; 
            let currentFilteredProducts = []; 
            let selectedMainCategoryId = 'all'; 
            let selectedSubCategoryId = null;   
            let lightGalleryInstance = null;
            const debouncedLgRefresh = debounce(initializeOrRefreshLightGallery, 250); // DEBOUNCED FONKSİYON TANIMLAMASI

            const cartItemCountBadge = document.getElementById('cartItemCountBadge');

            // Debounce fonksiyonu
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            function formatCurrency(value) {
                const formatter = new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                return formatter.format(value || 0);
            }
            
            window.promptAddToCart = function(stokKodu, stokAdi, satisFiyat1, bakiye) {
                satisFiyat1 = parseFloat(satisFiyat1);
                bakiye = parseFloat(bakiye);

                // Özel input alanı oluştur
                const inputDiv = document.createElement('div');
                inputDiv.innerHTML = `
                    <div class="modal fade" id="quantityModal" tabindex="-1" aria-labelledby="quantityModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="quantityModalLabel">Miktar</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="mb-2">"${stokAdi}" için miktar:</p>
                                    <input type="number" 
                                           class="form-control form-control-lg text-center" 
                                           id="quantityInput" 
                                           value="1" 
                                           min="1" 
                                           max="${bakiye > 0 ? bakiye : ''}"  // Stok 0 ise max sınırı olmasın veya farklı bir kontrol
                                           inputmode="numeric"
                                           pattern="[0-9]*">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                    <button type="button" class="btn btn-primary" id="confirmQuantity">Onayla</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(inputDiv);

                const quantityModalEl = document.getElementById('quantityModal');
                const quantityModal = new bootstrap.Modal(quantityModalEl);
                
                quantityModalEl.addEventListener('shown.bs.modal', function () {
                    document.getElementById('quantityInput').focus();
                    document.getElementById('quantityInput').select();
                });

                quantityModalEl.addEventListener('hidden.bs.modal', function () {
                    document.body.removeChild(inputDiv); // Modalı DOM'dan kaldır
                });
                
                quantityModal.show();

                document.getElementById('confirmQuantity').addEventListener('click', function() {
                    const quantityInputEl = document.getElementById('quantityInput');
                    const quantity = parseInt(quantityInputEl.value);
                    
                    if (isNaN(quantity) || quantity <= 0) {
                        alert("Geçersiz miktar girdiniz.");
                        quantityInputEl.focus();
                        return;
                    }
                    if (bakiye > 0 && quantity > bakiye) {
                         alert(`Yetersiz stok! Bu ürün için en fazla ${bakiye} adet sipariş verebilirsiniz.`);
                         quantityInputEl.focus();
                         return;
                    }

                    quantityModal.hide(); // Miktar modalını gizle

                    // Fiyat girişi için ikinci modal
                    const priceDiv = document.createElement('div');
                    priceDiv.innerHTML = `
                        <div class="modal fade" id="priceModal" tabindex="-1" aria-labelledby="priceModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="priceModalLabel">Fiyat</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p class="mb-2">"${stokAdi}" için birim fiyat:</p>
                                        <input type="number" 
                                               class="form-control form-control-lg text-center" 
                                               id="priceInput" 
                                               value="${satisFiyat1.toFixed(2)}" 
                                               min="0" 
                                               step="0.01"
                                               inputmode="decimal">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                        <button type="button" class="btn btn-primary" id="confirmPrice">Onayla</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(priceDiv);

                    const priceModalEl = document.getElementById('priceModal');
                    const priceModal = new bootstrap.Modal(priceModalEl);

                    priceModalEl.addEventListener('shown.bs.modal', function () {
                        document.getElementById('priceInput').focus();
                        document.getElementById('priceInput').select();
                    });
                    
                    priceModalEl.addEventListener('hidden.bs.modal', function () {
                        document.body.removeChild(priceDiv); // Modalı DOM'dan kaldır
                    });

                    priceModal.show();

                    document.getElementById('confirmPrice').addEventListener('click', function() {
                        const priceInputEl = document.getElementById('priceInput');
                        const price = parseFloat(priceInputEl.value);
                        if (isNaN(price) || price < 0) {
                            alert("Geçersiz fiyat girdiniz.");
                            priceInputEl.focus();
                            return;
                        }
                        priceModal.hide();
                        addItemToCart(stokKodu, stokAdi, quantity, price, bakiye);
                    });
                });
            }

            function addItemToCart(stokKodu, stokAdi, quantity, price, bakiye) {
                let cartItems = getCartItemsFromStorage();
                const existingItemIndex = cartItems.findIndex(item => item.stokKodu === stokKodu);
                if (existingItemIndex > -1) {
                    cartItems[existingItemIndex].quantity = cartItems[existingItemIndex].quantity + quantity;
                    cartItems[existingItemIndex].price = price; 
                } else {
                    cartItems.push({ stokKodu, stokAdi, quantity, price, bakiye });
                }
                saveCartItemsToStorage(cartItems);
                alert(`"${stokAdi}" sepete eklendi.`);
            }
            
            function getCartItemsFromStorage() {
                const items = localStorage.getItem('b2bCartItems');
                return items ? JSON.parse(items) : [];
            }

            function saveCartItemsToStorage(cartItems) {
                localStorage.setItem('b2bCartItems', JSON.stringify(cartItems));
                updateCartBadge();
            }

            function updateCartBadge() {
                const cartItems = getCartItemsFromStorage();
                const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                if (totalItems > 0) {
                    cartItemCountBadge.textContent = totalItems;
                    cartItemCountBadge.style.display = 'inline-block';
                } else {
                    cartItemCountBadge.style.display = 'none';
                }
            }

            function updateActiveCategoriesAndRenderNavbar(products) {
                const productGrupKodlari = new Set(products.map(p => p.GRUP_KODU).filter(Boolean));
                activeCategoryStructure = AnaKategoriYapisi.map(mainCat => {
                    const activeGrupKodlari = mainCat.grupKodlari.filter(grupKod => productGrupKodlari.has(grupKod));
                    return { ...mainCat, activeGrupKodlari, hasProducts: activeGrupKodlari.length > 0 };
                }).filter(mainCat => mainCat.hasProducts);

                const allProductsLinkLi = mainCategoriesNav.querySelector('li:first-child');
                mainCategoriesNav.innerHTML = ''; 
                if(allProductsLinkLi) mainCategoriesNav.appendChild(allProductsLinkLi); 

                activeCategoryStructure.forEach(mainCat => {
                    const li = document.createElement('li');
                    li.className = 'nav-item dropdown';

                    const aToggle = document.createElement('a');
                    aToggle.className = 'nav-link dropdown-toggle';
                    aToggle.href = '#';
                    aToggle.id = `navbarDropdown_${mainCat.id}`;
                    aToggle.setAttribute('role', 'button');
                    aToggle.setAttribute('data-bs-toggle', 'dropdown');
                    aToggle.setAttribute('aria-expanded', 'false');
                    aToggle.textContent = mainCat.ad;
                    aToggle.dataset.categoryid = mainCat.id; 
                    li.appendChild(aToggle);

                    const ulDropdown = document.createElement('ul');
                    ulDropdown.className = 'dropdown-menu';
                    ulDropdown.setAttribute('aria-labelledby', `navbarDropdown_${mainCat.id}`);

                    const allSubLi = document.createElement('li');
                    const allSubA = document.createElement('a');
                    allSubA.className = 'dropdown-item';
                    allSubA.href = '#';
                    allSubA.textContent = `Tümü (${mainCat.ad})`;
                    allSubA.dataset.categoryid = mainCat.id;
                    allSubA.dataset.grupkod = 'all_sub'; 
                    allSubLi.appendChild(allSubA);
                    ulDropdown.appendChild(allSubLi);
                    
                    const dividerLi = document.createElement('li');
                    const hr = document.createElement('hr');
                    hr.className = 'dropdown-divider';
                    dividerLi.appendChild(hr);
                    ulDropdown.appendChild(dividerLi);

                    mainCat.activeGrupKodlari.forEach(grupKod => {
                        const subLi = document.createElement('li');
                        const subA = document.createElement('a');
                        subA.className = 'dropdown-item';
                        subA.href = '#';
                        subA.textContent = grupKod;
                        subA.dataset.grupkod = grupKod;
                        subLi.appendChild(subA);
                        ulDropdown.appendChild(subLi);
                    });
                    li.appendChild(ulDropdown);
                    mainCategoriesNav.appendChild(li);
                });
                 updateActiveLinks(); 
            }

            function filterAndRenderProducts(searchTerm = '', mainCatId = selectedMainCategoryId, subCatId = selectedSubCategoryId) {
                console.log('[FILTER] Başlangıç:', { mainCatId, subCatId, searchTerm });
                let filteredProducts = [...allProducts];
                console.log('[FILTER] Tüm ürünler sayısı:', filteredProducts.length);

                // 1. Ana Kategori Filtresi
                if (mainCatId && mainCatId !== 'all') {
                    const mainCategory = activeCategoryStructure.find(mc => mc.id === mainCatId);
                    console.log('[FILTER] Seçilen Ana Kategori Obj:', mainCategory);
                    if (mainCategory && mainCategory.activeGrupKodlari) {
                        filteredProducts = filteredProducts.filter(p => mainCategory.activeGrupKodlari.includes(p.GRUP_KODU));
                        console.log('[FILTER] Ana Kategori Filtresi Sonrası Ürün Sayısı:', filteredProducts.length, 'Ana Kat. Grupları:', mainCategory.activeGrupKodlari);

                        // 2. Alt Kategori Filtresi (Ana kategori filtresi uygulandıktan SONRA)
                        if (subCatId && subCatId !== 'all_sub') {
                            console.log('[FILTER] Alt Kategori Filtresi Uygulanıyor. Seçilen subCatId:', subCatId);
                            const tempFilteredBySub = filteredProducts.filter(p => p.GRUP_KODU === subCatId);
                            console.log('[FILTER] Alt Kategori Filtresi Sonrası Ürün Sayısı (geçici):', tempFilteredBySub.length);
                            filteredProducts = tempFilteredBySub;
                        } else {
                            console.log('[FILTER] Alt Kategori Filtresi Atlandı (ya all_sub ya da subCatId yok):', subCatId);
                        }
                    } else {
                        console.log('[FILTER] Geçerli ana kategori bulunamadı veya activeGrupKodlari boş. Ürünler sıfırlandı.');
                        filteredProducts = [];
                    }
                } else {
                    console.log('[FILTER] Ana Kategori Filtresi Atlandı (Tüm Ürünler).');
                }

                // 3. Arama Filtresi (En son, o ana kadar filtrelenmiş ürünlere uygulanır)
                if (searchTerm) {
                    console.log('[FILTER] Arama Filtresi Uygulanıyor. Terim:', searchTerm);
                    const lowerSearchTerm = searchTerm.toLocaleLowerCase('tr-TR');
                    filteredProducts = filteredProducts.filter(p => 
                        (p.STOK_ADI && p.STOK_ADI.toLocaleLowerCase('tr-TR').includes(lowerSearchTerm)) ||
                        (p.STOK_KODU && p.STOK_KODU.toLocaleLowerCase('tr-TR').includes(lowerSearchTerm)) ||
                        (p.GRUP_KODU && p.GRUP_KODU.toLocaleLowerCase('tr-TR').includes(lowerSearchTerm)) ||
                        (p.BARKOD1 && p.BARKOD1.toLocaleLowerCase('tr-TR').includes(lowerSearchTerm))
                    );
                    console.log('[FILTER] Arama Filtresi Sonrası Ürün Sayısı:', filteredProducts.length);
                } else {
                    console.log('[FILTER] Arama Filtresi Atlandı.');
                }

                currentFilteredProducts = filteredProducts; 
                console.log('[FILTER] Render edilecek ürün sayısı:', currentFilteredProducts.length);
                renderTable(currentFilteredProducts);
            }
            
            function updateActiveLinks() {
                document.querySelectorAll('#main-categories-nav > .nav-item > .nav-link').forEach(link => {
                    link.classList.remove('active', 'active-main-category');
                    if (link.dataset.categoryid === selectedMainCategoryId && (selectedSubCategoryId === null || selectedSubCategoryId === 'all_sub')) {
                        link.classList.add('active', 'active-main-category');
                    }
                });

                document.querySelectorAll('#main-categories-nav .dropdown-item').forEach(item => {
                    item.classList.remove('active-sub-category');
                    if (item.dataset.grupkod === selectedSubCategoryId && selectedSubCategoryId !== 'all_sub') {
                        item.classList.add('active-sub-category');
                    }
                });
                if (selectedMainCategoryId === 'all') {
                    const allProductsLink = document.querySelector('#main-categories-nav .nav-link[data-categoryid="all"]');
                    if (allProductsLink) {
                        allProductsLink.classList.add('active', 'active-main-category');
                    }
                }
            }
            
            function initializeOrRefreshLightGallery() {
                if (lightGalleryInstance) {
                    try {
                        lightGalleryInstance.destroy();
                    } catch (e) { /* Hata olursa görmezden gel */ }
                }
                try {
                    lightGalleryInstance = lightGallery(productTableContainer, {
                        selector: '.product-image',
                        dynamic: false, 
                        download: false, 
                        counter: true, 
                        plugins: [], // lgZoom eklentisi geçici olarak kaldırılmıştı
                    });
                } catch (e) {
                    console.error("LightGallery başlatılırken hata oluştu:", e); // BU MESAJI KONSOLDA GÖRÜYOR MUSUNUZ?
                }
            }

            function renderTable(productsToRender) {
                productTableContainer.innerHTML = ''; 
                if (productsToRender && productsToRender.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'table table-striped table-hover table-bordered table-sm'; 
                    const thead = document.createElement('thead');
                    thead.className = 'table-light'; 
                    const tbody = document.createElement('tbody');
                    const headerRow = document.createElement('tr');
                    
                    const headers = ["Resim", "Stok Adı", "Bakiye", "", "Satış Fiyatı", "Grup Kodu", "Barkod", "Stok Kodu"];
                    const productKeys = ["STOK_ADI", "BAKIYE", "SATIS_FIAT1", "GRUP_KODU", "BARKOD1", "STOK_KODU"];

                    headers.forEach((headerText) => {
                        const th = document.createElement('th');
                        th.scope = "col";
                        th.style.verticalAlign = 'middle';
                        if (headerText) {
                            th.textContent = headerText;
                        }
                        if (headerText === "Stok Adı") { th.classList.add('col-stok-adi'); }
                        if (headerText === "") { 
                            th.classList.add('action-cell');
                        } 
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    productsToRender.forEach(product => {
                        const tr = document.createElement('tr');
                        
                        const tdImage = document.createElement('td');
                        tdImage.style.textAlign = 'center';
                        tdImage.style.verticalAlign = 'middle';
                        const imgContainer = document.createElement('div'); // Lightgallery'nin her bir öğeyi sarması için
                        imgContainer.className = 'lightgallery-item'; // Lightgallery'nin bulması için
                        
                        const img = document.createElement('img');
                        const baseImagePath = `/static/images/product_${product.STOK_KODU}`;
                        const placeholderPath = '/static/images/urun_yok.png';
                        
                        img.alt = product.STOK_ADI || 'Ürün Resmi';
                        img.className = 'product-image';
                        
                        img.dataset.src = `${baseImagePath}.jpg`; // Başlangıçta .jpg olarak ayarla

                        img.onload = function() {
                            // .jpg başarıyla yüklendi. dataset.src zaten doğru.
                        };

                        img.onerror = function() { // .jpg yüklenemedi
                            this.src = `${baseImagePath}.png`;      // .png'yi yüklemeyi dene (thumbnail için)
                            this.dataset.src = `${baseImagePath}.png`; // Lightgallery için dataset.src'yi .png olarak güncelle
                            debouncedLgRefresh();   // Lightgallery'yi yenilemesi için işaretle

                            this.onload = function() {
                                // .png başarıyla yüklendi.
                            };
                            this.onerror = function() { // .png de yüklenemedi
                                this.src = placeholderPath;      // urun_yok.png'yi yükle (thumbnail için)
                                this.dataset.src = placeholderPath; // Lightgallery için dataset.src'yi placeholder olarak güncelle
                                debouncedLgRefresh();      // Lightgallery'yi yenilemesi için işaretle
                                
                                this.onload = function() {
                                    // urun_yok.png başarıyla yüklendi
                                };
                                this.onerror = null; // Hata döngüsünü engelle
                            };
                        };
                        
                        img.src = `${baseImagePath}.jpg`; // .jpg'yi yüklemeye başla (thumbnail için)
                        
                        imgContainer.appendChild(img);
                        tdImage.appendChild(imgContainer);
                        tr.insertBefore(tdImage, tr.firstChild); // Resmi ilk sütuna ekle

                        const tdAction = document.createElement('td');
                        tdAction.className = 'action-cell';
                        const bakiye = parseFloat(product.BAKIYE || 0);
                        const satisFiyati = parseFloat(product.SATIS_FIAT1 || 0);
                        const stokAdiEscaped = product.STOK_ADI ? product.STOK_ADI.replace(/'/g, "\\'").replace(/"/g, "&quot;") : '';
                        
                        if (bakiye > 0) {
                            tdAction.innerHTML = `
                                <button class="btn btn-sm cart-icon-button" title="Sepete Ekle"
                                        onclick="promptAddToCart('${product.STOK_KODU}', '${stokAdiEscaped}', ${satisFiyati}, ${bakiye})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart-plus" viewBox="0 0 16 16">
                                        <path d="M9 5.5a.5.5 0 0 0-1 0V7H6.5a.5.5 0 0 0 0 1H8v1.5a.5.5 0 0 0 1 0V8h1.5a.5.5 0 0 0 0-1H9V5.5z"/>
                                        <path d="M.5 1a.5.5 0 0 0 0 1h1.11l.401 1.607 1.498 7.985A.5.5 0 0 0 4 12h1a2 2 0 1 0 0 4 2 2 0 0 0 0-4h7a2 2 0 1 0 0 4 2 2 0 0 0 0-4h1a.5.5 0 0 0 .491-.408l1.5-8A.5.5 0 0 0 14.5 3H2.89l-.405-1.621A.5.5 0 0 0 2 1H.5zm3.915 10L3.102 4h10.796l-1.313 7h-8.17zM6 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm7 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                    </svg>
                                </button>`;
                        } else {
                            tdAction.innerHTML = '<span class="badge bg-danger">Stok Yok</span>';
                        }

                        const cellDataOrder = [
                            { key: "STOK_ADI", class: 'col-stok-adi' },
                            { key: "BAKIYE", format: val => parseFloat(val || 0).toFixed(0), align: 'center' },
                            "ACTION_CELL_PLACEHOLDER",
                            { key: "SATIS_FIAT1", format: formatCurrency, align: 'center' },
                            { key: "GRUP_KODU", align: 'center' },
                            { key: "BARKOD1" },
                            { key: "STOK_KODU" }
                        ];

                        cellDataOrder.forEach(item => {
                            if (item === "ACTION_CELL_PLACEHOLDER") {
                                tr.appendChild(tdAction);
                            } else {
                                const td = document.createElement('td');
                                if (item.class) { td.classList.add(item.class); }
                                
                                let value = product[item.key];
                                if (item.format) {
                                    td.textContent = item.format(value);
                                } else {
                                    td.textContent = value || '';
                                }
                                
                                if (item.align) { 
                                    td.style.textAlign = item.align; 
                                }
                                
                                td.style.verticalAlign = 'middle';
                                
                                tr.appendChild(td);
                            }
                        });
                        
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'table-responsive-sm';
                    tableWrapper.appendChild(table);
                    productTableContainer.appendChild(tableWrapper);
                    initializeOrRefreshLightGallery();
                } else {
                    // Çevrimdışı durumda ürün bulunamazsa daha anlamlı bir mesaj göster
                    const offlineMessage = '<p class="text-center text-muted mt-4">Çevrimdışı moddasınız ve önbellekte ürün bulunamadı. Lütfen internete bağlanıp tekrar deneyin.</p>';
                    const onlineMessage = '<p class="text-center text-muted mt-4">Aramanızla eşleşen ürün bulunamadı veya seçili kategoride ürün yok.</p>';
                    productTableContainer.innerHTML = navigator.onLine ? onlineMessage : offlineMessage;
                }
            }

            searchInput.addEventListener('input', debounce(function() {
                filterAndRenderProducts(this.value.trim(), selectedMainCategoryId, selectedSubCategoryId);
            }, 300)); // 300ms gecikme ile debounce uygula
            
            mainCategoriesNav.addEventListener('click', function(event) {
                const target = event.target.closest('a'); 
                if (!target) return;

                // Eğer tıklanan element bir dropdown toggle ise, Bootstrap'in kendi işlevini yapmasına izin ver.
                // Sadece event.preventDefault() çağırarak href="#" yönlendirmesini engelle.
                if (target.classList.contains('dropdown-toggle') && target.getAttribute('data-bs-toggle') === 'dropdown') {
                    event.preventDefault();
                    // Dropdown'ın açılıp kapanması Bootstrap tarafından otomatik olarak yönetilecektir.
                    // Bu durumda filtreleme veya active link güncellemesi yapmıyoruz.
                    return; 
                }

                // Diğer tüm linkler (Tüm Ürünler, dropdown içindeki alt kategori linkleri) için varsayılan davranışı engelle
                event.preventDefault();

                const mainCatIdFromToggle = target.dataset.maincategoryid; // Dropdown toggle için (yukarıdaki if'e takılmazsa buraya gelmez)
                const grupKod = target.dataset.grupkod; // Alt kategori için
                const categoryIdFromLink = target.dataset.categoryid; // "Tüm Ürünler" veya alt kategorinin "Tümü" linki için

                let hideActiveDropdown = true;

                if (categoryIdFromLink) { // "Tüm Ürünler" veya bir ana kategorinin "Tümü (Ana Kategori Adı)" linki
                    selectedMainCategoryId = categoryIdFromLink;
                    selectedSubCategoryId = target.dataset.grupkod === 'all_sub' ? 'all_sub' : null;
                    if (target.dataset.grupkod === 'all_sub') { // "Tümü (Ana Kategori Adı)" tıklandı
                         // selectedSubCategoryId zaten ayarlandı, dropdown'ı kapat
                    } else { // "Tüm Ürünler" tıklandı
                        // selectedSubCategoryId null olarak kalacak.
                    }
                } else if (grupKod && target.closest('.dropdown-menu')) { // Dropdown içindeki spesifik bir alt kategori linki
                    const parentDropdownToggle = target.closest('.dropdown').querySelector('.dropdown-toggle');
                    if (parentDropdownToggle && parentDropdownToggle.dataset.categoryid) {
                        selectedMainCategoryId = parentDropdownToggle.dataset.categoryid;
                        selectedSubCategoryId = grupKod;
                    } else {
                        // Bu durum olmamalı, ama bir güvenlik önlemi
                        console.error("Ana kategori ID'si bulunamadı.");
                        return;
                    }
                } else {
                    // Tanımlanmayan bir tıklama, hiçbir şey yapma (veya bir log bas)
                    // veya dropdown açıksa gizleme.
                    hideActiveDropdown = false; // Belirsiz bir tıklama ise dropdown'ı kapatma
                }
                
                if (hideActiveDropdown) {
                    const activeDropdown = mainCategoriesNav.querySelector('.dropdown-menu.show');
                    if (activeDropdown) {
                        const instance = bootstrap.Dropdown.getInstance(activeDropdown.previousElementSibling);
                        if (instance) {
                            instance.hide();
                        }
                    }
                }
                
                updateActiveLinks();
                filterAndRenderProducts(searchInput.value.trim(), selectedMainCategoryId, selectedSubCategoryId);

                // Mobil görünümde, bir seçim yapıldıktan sonra ana navbar'ı kapat
                const navbarToggler = document.querySelector('.navbar-toggler');
                const navbarCollapse = document.getElementById('navbarNav');
                // Toggler görünürse (yani mobil moddaysak) ve navbar açıksa, kapat.
                if (navbarToggler && getComputedStyle(navbarToggler).display !== 'none' && navbarCollapse.classList.contains('show')) {
                    const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                }
            });

            // Hızlı Stok Kodu ile Ekleme Fonksiyonu
            function addByStockCode() {
                const stockCode = quickStockCodeInput.value.trim();
                if (!stockCode) {
                    alert("Lütfen bir stok kodu girin.");
                    quickStockCodeInput.focus();
                    return;
                }

                const product = allProducts.find(p => p.STOK_KODU === stockCode);

                if (product) {
                    const satisFiyat1 = parseFloat(product.SATIS_FIAT1 || 0);
                    const bakiye = parseFloat(product.BAKIYE || 0);
                    const stokAdiEscaped = product.STOK_ADI ? product.STOK_ADI.replace(/'/g, "\\\\'").replace(/"/g, "&quot;") : '';
                    
                    // Miktar ve fiyat sormak için promptAddToCart'u çağır
                    promptAddToCart(product.STOK_KODU, stokAdiEscaped, satisFiyat1, bakiye);
                    quickStockCodeInput.value = ''; // Input'u temizle
                } else {
                    alert(`Stok kodu "${stockCode}" bulunamadı.`);
                    quickStockCodeInput.select();
                }
            }

            if(quickAddByStockCodeButton) { // Butonun varlığını kontrol et
                quickAddByStockCodeButton.addEventListener('click', addByStockCode);
            }
            if(quickStockCodeInput) { // Input'un varlığını kontrol et
                quickStockCodeInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        addByStockCode();
                    }
                });
            }

            // --- GÜNCELLENMİŞ Ürün Yükleme Fonksiyonu ---
            // Bu fonksiyon artık sadece internetten veri çekip DB'ye kaydeder.
            async function fetchAndCacheProducts() {
                syncButton.disabled = true;
                const originalButtonHTML = syncButton.innerHTML;
                syncButton.innerHTML = `
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Yükleniyor...
                `;

                try {
                    console.log("Ürünler internetten çekiliyor...");
                    const response = await fetch('/api/products');
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    const products = await response.json();
                    
                    console.log("Ürünler internetten başarıyla çekildi, IndexedDB'ye kaydediliyor.");
                    await setInDB(db, 'products', products);

                    // Başarı mesajını kaldır (eğer varsa) ve butonu güncelle
                    const offlineAlert = document.getElementById('offline-alert');
                    if (offlineAlert) offlineAlert.remove();
                    syncButton.classList.remove('btn-info', 'btn-danger');
                    syncButton.classList.add('btn-success');
                    syncButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16" style="vertical-align: -0.125em; margin-right: 5px;">
                           <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                        </svg>
                        Veriler Güncel
                    `;
                    
                    // Verileri ekrana bas
                    processAndRenderProducts(products);

                } catch (error) {
                    console.error("Veri senkronizasyonu başarısız:", error);
                    syncButton.classList.remove('btn-info', 'btn-success');
                    syncButton.classList.add('btn-danger');
                    syncButton.textContent = 'Güncelleme Başarısız!';
                    alert('Veriler güncellenemedi. İnternet bağlantınızı kontrol edin.');
                } finally {
                    // Butonu bir süre sonra eski haline getir
                    setTimeout(() => {
                        syncButton.disabled = false;
                        syncButton.innerHTML = originalButtonHTML;
                        syncButton.classList.remove('btn-success', 'btn-danger');
                        syncButton.classList.add('btn-info');
                    }, 3000);
                }
            }
            
            // Bu fonksiyon sadece ürünleri alır ve ekrana basar
            function processAndRenderProducts(products) {
                products.sort((a, b) => {
                    const grupA = a.GRUP_KODU || '';
                    const grupB = b.GRUP_KODU || '';

                    if (grupA < grupB) {
                        return -1;
                    }
                    if (grupA > grupB) {
                        return 1;
                    }

                    const nameA = a.STOK_ADI || '';
                    const nameB = b.STOK_ADI || '';
                    return nameA.localeCompare(nameB, 'tr', { sensitivity: 'base' });
                });
                allProducts = products;
                updateActiveCategoriesAndRenderNavbar(allProducts); 
                filterAndRenderProducts(); 
                updateActiveLinks(); 
                updateCartBadge();
            }

            // GÜNCELLENMİŞ Sayfa Yükleme Mantığı
            async function loadInitialData() {
                try {
                    console.log("IndexedDB açılıyor...");
                    db = await openDB('FiratB2B_DB');
                    console.log("IndexedDB başarıyla açıldı.");
                    
                    console.log("Başlangıç için veriler IndexedDB'den okunuyor...");
                    const products = await getFromDB(db, 'products');

                    if (products && Array.isArray(products) && products.length > 0) {
                        console.log(`${products.length} ürün IndexedDB'den başarıyla okundu.`);
                        processAndRenderProducts(products);
                        
                        // Çevrimdışı uyarısı göster
                        if (!navigator.onLine && !document.getElementById('offline-alert')) {
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-warning text-center';
                            alertDiv.id = 'offline-alert';
                            alertDiv.textContent = 'Çevrimdışı modda çalışıyorsunuz. Gösterilen veriler en son kaydedilen verilerdir.';
                            const mainElement = document.querySelector('main.px-md-4');
                            if (mainElement) {
                                mainElement.prepend(alertDiv);
                            }
                        }

                    } else {
                        console.log("IndexedDB'de ürün bulunamadı veya geçersiz format. Kullanıcının güncelleme yapması bekleniyor.");
                        productTableContainer.innerHTML = `
                            <div class="alert alert-primary text-center">
                                <h5>Hoş Geldiniz!</h5>
                                <p>Çevrimdışı kullanım için lütfen <strong>'Verileri Güncelle'</strong> butonuna basarak en güncel ürün listesini tabletinize indirin.</p>
                            </div>
                        `;
                    }

                } catch (e) {
                    console.error("IndexedDB hatası:", e);
                    productTableContainer.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <h5>Veritabanı Hatası</h5>
                            <p>Uygulama veritabanı başlatılamadı. Lütfen:</p>
                            <ul class="list-unstyled">
                                <li>• Sayfayı yeniden yükleyin</li>
                                <li>• Tarayıcınızın güncel olduğundan emin olun</li>
                                <li>• Özel/gizli modda olmadığınızdan emin olun</li>
                            </ul>
                            <button class="btn btn-primary" onclick="location.reload()">Sayfayı Yenile</button>
                        </div>
                    `;
                    if (syncButton) {
                        syncButton.disabled = true;
                    }
                }
            }
            
            // Butonun click olayını ata
            syncButton.addEventListener('click', fetchAndCacheProducts);

            // Sayfa yüklendiğinde ilk veriyi yükle
            loadInitialData();
            
            updateCartBadge();
        });

        window.initiateOrderDownload = function() {
            const cartItems = getCartItemsFromStorage();
            if (cartItems.length === 0) {
                alert("Dışa aktarılacak ürün bulunmuyor.");
                return;
            }

            const customerName = document.getElementById('customerName').value.trim() || "Bilinmeyen Cari";
            const exportFormat = document.getElementById('exportFormat').value;

            let dataToExport = [];
            dataToExport.push(["Stok Kodu", "Barkod", "Ürün Adı", "Miktar", "Birim Fiyat", "Toplam Fiyat"]);

            cartItems.forEach(item => {
                const productInfo = allProducts.find(p => p.STOK_KODU === item.stokKodu);
                const barkod = productInfo ? (productInfo.BARKOD1 || '') : '';
                dataToExport.push([
                    item.stokKodu,
                    barkod,
                    item.stokAdi,
                    "'" + String(item.quantity),
                    formatCurrency(item.price),
                    formatCurrency(item.quantity * item.price)
                ]);
            });

            const grandTotal = cartItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            dataToExport.push([]); 
            dataToExport.push(["", "", "", "", "Genel Toplam:", formatCurrency(grandTotal)]);

            if (exportFormat === 'excel') {
                let csvContent = '\uFEFF';
                dataToExport.forEach(function(rowArray) {
                    let row = rowArray.map(function(val) {
                        let cell = String(val);
                        cell = cell.replace(/"/g, '""'); 
                        return '"' + cell + '"';
                    }).join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const safeCustomerName = customerName.replace(/[^a-z0-9_\-]/gi, '_').substring(0, 50);
                const fileName = `Siparis_${safeCustomerName}_${new Date().toISOString().slice(0,10)}.csv`;
                link.setAttribute("download", fileName);
                document.body.appendChild(link); 
                link.click();
                document.body.removeChild(link);
                alert("Sipariş CSV olarak indirildi: " + fileName);
            } else if (exportFormat === 'pdf') {
                alert("PDF dışa aktarma özelliği henüz geliştirilmemiştir.");
            }
        }
    </script>

    <!-- Bootstrap JS and Popper.js (Bundle) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Lightgallery JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script>
</body>
</html>